name: StudevPH Next.js CI/CD Pipeline

on:
  push:
    branches:
      - development
      - qa
      - uat
      - production
      - master
  pull_request:
    branches:
      - development
      - qa
      - uat
      - production
      - master
  workflow_dispatch:

env:
  IMAGE_NAME: studevph-app
  REGISTRY: docker.io
  COMPOSE_FILE: docker-compose.yml

jobs:
  # 1. Validate & Install Dependencies
  validate:
    name: Validate & Install
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm ci

      - name: Validate Next.js Build
        run: npm run build

  # 2. Build & Push Docker Image
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:${{ github.sha }}

  # 3. Deploy to Development
  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/development'
    environment: development

    steps:
      - uses: actions/checkout@v4

      - name: Deploy Development
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest
          docker compose up -d --build --remove-orphans

  # 4. Deploy to QA
  deploy-qa:
    name: Deploy to QA
    runs-on: ubuntu-latest
    needs: deploy-development
    if: github.ref == 'refs/heads/qa'
    environment: qa

    steps:
      - uses: actions/checkout@v4

      - name: Deploy QA
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest
          docker compose up -d --build --remove-orphans

  # 5. Deploy to UAT
  deploy-uat:
    name: Deploy to UAT
    runs-on: ubuntu-latest
    needs: deploy-qa
    if: github.ref == 'refs/heads/uat'
    environment: uat

    steps:
      - uses: actions/checkout@v4

      - name: Deploy UAT
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest
          docker compose up -d --build --remove-orphans

  # 6. Deploy to Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-uat
    if: github.ref == 'refs/heads/production'
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Deploy Production
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest
          docker compose up -d --build --remove-orphans

  # 7. Deploy to Master (latest)
  deploy-master:
    name: Deploy to Master
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/master'
    environment: master

    steps:
      - uses: actions/checkout@v4

      - name: Deploy Master
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest
          docker compose up -d --build --remove-orphans
