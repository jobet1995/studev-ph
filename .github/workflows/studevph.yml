name: StudevPH CI/CD Pipeline

on:
  push:
    branches:
      - development
      - qa
      - uat
      - production
      - master

  pull_request:
    branches:
      - development
      - qa
      - uat
      - production
      - master

env:
  IMAGE_NAME: studevph-web

jobs:
  build:
    name: Build & Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set environment variables by branch
        run: |
          BRANCH="${GITHUB_REF##*/}"

          if [[ "$BRANCH" == "development" ]]; then
            echo "ENV_FILE=${{ secrets.DEV_ENV_FILE }}" >> $GITHUB_ENV
            echo "TAG=dev" >> $GITHUB_ENV
          elif [[ "$BRANCH" == "qa" ]]; then
            echo "ENV_FILE=${{ secrets.QA_ENV_FILE }}" >> $GITHUB_ENV
            echo "TAG=qa" >> $GITHUB_ENV
          elif [[ "$BRANCH" == "uat" ]]; then
            echo "ENV_FILE=${{ secrets.UAT_ENV_FILE }}" >> $GITHUB_ENV
            echo "TAG=uat" >> $GITHUB_ENV
          elif [[ "$BRANCH" == "production" ]]; then
            echo "ENV_FILE=${{ secrets.PROD_ENV_FILE }}" >> $GITHUB_ENV
            echo "TAG=prod" >> $GITHUB_ENV
          elif [[ "$BRANCH" == "master" ]]; then
            echo "ENV_FILE=${{ secrets.PROD_ENV_FILE }}" >> $GITHUB_ENV
            echo "TAG=latest" >> $GITHUB_ENV

      - name: Create .env file (runtime only)
        run: echo "$ENV_FILE" > .env

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npx next lint

      - name: Run JSDoc Validation
        run: |
          npx eslint "pages/**/*.js" "components/**/*.js" "lib/**/*.js" \
            --plugin jsdoc \
            --rule 'jsdoc/require-jsdoc: ["error", { "require": { "FunctionDeclaration": true, "MethodDefinition": true, "ClassDeclaration": true, "ArrowFunctionExpression": false }}]' \
            --rule 'jsdoc/require-param: "error"' \
            --rule 'jsdoc/require-returns: "error"' \
            --max-warnings=0

      - name: Build Docker image (no push)
        run: docker build --build-arg NODE_ENV=production -t $IMAGE_NAME:$TAG .

  push-image:
    name: Build & Push Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set environment variables by branch
        run: |
          BRANCH="${GITHUB_REF##*/}"

          if [[ "$BRANCH" == "development" ]]; then
            echo "ENV_FILE=${{ secrets.DEV_ENV_FILE }}" >> $GITHUB_ENV
            echo "TAG=dev" >> $GITHUB_ENV
          elif [[ "$BRANCH" == "qa" ]]; then
            echo "ENV_FILE=${{ secrets.QA_ENV_FILE }}" >> $GITHUB_ENV
            echo "TAG=qa" >> $GITHUB_ENV
          elif [[ "$BRANCH" == "uat" ]]; then
            echo "ENV_FILE=${{ secrets.UAT_ENV_FILE }}" >> $GITHUB_ENV
            echo "TAG=uat" >> $GITHUB_ENV
          elif [[ "$BRANCH" == "production" ]]; then
            echo "ENV_FILE=${{ secrets.PROD_ENV_FILE }}" >> $GITHUB_ENV
            echo "TAG=prod" >> $GITHUB_ENV
          elif [[ "$BRANCH" == "master" ]]; then
            echo "ENV_FILE=${{ secrets.PROD_ENV_FILE }}" >> $GITHUB_ENV
            echo "TAG=latest" >> $GITHUB_ENV

      - name: Create .env file (runtime only)
        run: echo "$ENV_FILE" > .env

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        run: docker build --build-arg NODE_ENV=production -t ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:$TAG .

      - name: Push Docker image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:$TAG
