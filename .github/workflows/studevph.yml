name: StudevPH CI/CD Pipeline

on:
  push:
    branches:
      - development
      - qa
      - uat
      - production
      - master

  pull_request:
    branches:
      - development
      - qa
      - uat
      - production
      - master

env:
  IMAGE_NAME: studevph-web

jobs:
  set-env:
    name: Set Branch Environment
    runs-on: ubuntu-latest
    outputs:
      env_file: ${{ steps.set-env.outputs.env_file }}
      tag: ${{ steps.set-env.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine branch environment
        id: set-env
        run: |
          BRANCH="${GITHUB_REF##*/}"
          if [[ "$BRANCH" == "development" ]]; then
            echo "env_file=${{ secrets.DEV_ENV_FILE }}" >> $GITHUB_OUTPUT
            echo "tag=dev" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "qa" ]]; then
            echo "env_file=${{ secrets.QA_ENV_FILE }}" >> $GITHUB_OUTPUT
            echo "tag=qa" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "uat" ]]; then
            echo "env_file=${{ secrets.UAT_ENV_FILE }}" >> $GITHUB_OUTPUT
            echo "tag=uat" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "production" ]]; then
            echo "env_file=${{ secrets.PROD_ENV_FILE }}" >> $GITHUB_OUTPUT
            echo "tag=prod" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "master" ]]; then
            echo "env_file=${{ secrets.PROD_ENV_FILE }}" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build & Validate
    runs-on: ubuntu-latest
    needs: set-env
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file
        run: echo "${{ needs.set-env.outputs.env_file }}" > .env

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npx next lint

      - name: Run JSDoc Validation
        run: |
          npx eslint "pages/**/*.js" "components/**/*.js" "lib/**/*.js" \
            --plugin jsdoc \
            --rule 'jsdoc/require-jsdoc: ["error", { "require": { "FunctionDeclaration": true, "MethodDefinition": true, "ClassDeclaration": true, "ArrowFunctionExpression": false }}]' \
            --rule 'jsdoc/require-param: "error"' \
            --rule 'jsdoc/require-returns: "error"' \
            --max-warnings=0

      - name: Build Docker image
        run: docker build --build-arg NODE_ENV=production -t $IMAGE_NAME:${{ needs.set-env.outputs.tag }} .

  deploy:
    name: Deploy Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file
        run: echo "${{ needs.set-env.outputs.env_file }}" > .env

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push Docker image
        run: |
          docker tag $IMAGE_NAME:${{ needs.set-env.outputs.tag }} ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:${{ needs.set-env.outputs.tag }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:${{ needs.set-env.outputs.tag }}
